# Author: Justin Henderson
#         SANS Instructor and author of SANS SEC555: SIEM and Tactical Analytics
# Email: justin@hasecuritysolutions.com
# Last Update: 3/23/2018
#

filter {
  if [log_event_type] =~ /^bro_/ {
    json {
      source => "message"
      remove_field => "message"
    }
    grok {
      match => { "log_event_type" => "^bro_(?<event_type>[a-z0-9]+)" }
    }
    date {
      match => [ "ts", "ISO8601" ]
      remove_field => [ "ts" ]
    }
    mutate {
      replace => { "log_event_type" => "bro" }
      rename => { "id.orig_h" => "source_ip" }
      rename => { "id.orig_p" => "source_port" }
      rename => { "id.resp_h" => "destination_ip" }
      rename => { "id.resp_p" => "destination_port" }
    }
    if [event_type] == "dns" {
      mutate {
        rename => { "qclass" => "query_class" }
        rename => { "qclass_name" => "query_class_name" }
        rename => { "qtype_name" => "query_type_name" }
        rename => { "AA" => "authoritative_answer" }
        rename => { "RA" => "server_recursion_supported" }
        rename => { "RD" => "client_recursion_desired" }
        rename => { "TC" => "truncated_message" }
        rename => { "TTLs" => "ttls" }
        rename => { "Z" => "reserved_bit" }
      }
    }
    if [event_type] == "http" {
      mutate {
        rename => { "request_body_len" => "request_body_length" }
        rename => { "response_body_len" => "response_body_length" }
        rename => { "status_msg" => "status_message" }
        rename => { "trans_id" => "transaction_id" }
        rename => { "trans_depth" => "transaction_depth" }
      }
    }
  }
}